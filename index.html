<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YASWANTH Fleet Audit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        [contenteditable="true"]:focus { background: #f1f5f9; outline: 2px solid #6366f1; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <header class="bg-white border-b sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-black text-indigo-600">YASWANTH</h1>
                <select id="year-select" onchange="changeYear(this.value)" class="bg-indigo-50 border-none rounded-lg px-3 py-1 font-bold text-indigo-700 cursor-pointer">
                    <option value="2025">2025</option>
                    <option value="2026" selected>2026</option>
                </select>
            </div>
            <nav class="flex gap-6 font-semibold">
                <button onclick="showPage('home')" class="hover:text-indigo-600">Home</button>
                <button onclick="showPage('bus-wise-audit')" class="hover:text-indigo-600">Reports</button>
            </nav>
        </div>
    </header>

    <div class="container mx-auto p-6">
        <main id="home" class="page block">
            <div class="text-center my-10">
                <h2 class="text-4xl font-extrabold tracking-tight">Fleet Dashboard <span id="display-year">2026</span></h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 hover:shadow-xl transition cursor-pointer" onclick="openSelector('audit')">
                    <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center mb-4 text-indigo-600">üìä</div>
                    <h3 class="text-xl font-bold">Monthly Audit</h3>
                    <p class="text-slate-500">Revenue & Expenses</p>
                </div>
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 hover:shadow-xl transition cursor-pointer" onclick="openSelector('diesel')">
                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mb-4 text-purple-600">‚õΩ</div>
                    <h3 class="text-xl font-bold">Diesel Audit</h3>
                    <p class="text-slate-500">Fuel Management</p>
                </div>
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 hover:shadow-xl transition cursor-pointer" onclick="openSelector('payroll')">
                    <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center mb-4 text-amber-600">üí∞</div>
                    <h3 class="text-xl font-bold">Payroll</h3>
                    <p class="text-slate-500">Driver Salaries</p>
                </div>
            </div>
        </main>

        <section id="selector-page" class="page bg-white p-10 rounded-3xl shadow-sm border">
            <button onclick="showPage('home')" class="text-indigo-600 font-bold mb-6">‚Üê Back to Home</button>
            <h2 id="selector-title" class="text-3xl font-black mb-8 capitalize">Select Month</h2>
            <div id="month-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </section>

        <section id="audit-table-page" class="page bg-white p-8 rounded-3xl shadow-sm border">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black"><span id="active-month-name"></span> <span class="year-val"></span></h2>
                <div class="flex gap-4">
                    <button onclick="addAuditRow()" class="bg-slate-100 px-5 py-2 rounded-xl font-bold">+ Add Bus</button>
                    <button onclick="saveAuditData()" class="bg-indigo-600 text-white px-8 py-2 rounded-xl font-bold shadow-lg shadow-indigo-200">Save Changes</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-slate-400 text-sm uppercase tracking-widest border-b">
                            <th class="pb-4">Bus Number</th>
                            <th class="pb-4">Revenue (Credit)</th>
                            <th class="pb-4">Expenses</th>
                            <th class="pb-4">Net Profit</th>
                            <th class="pb-4 w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="audit-tbody"></tbody>
                    <tfoot id="audit-tfoot" class="bg-slate-50 font-black"></tfoot>
                </table>
            </div>
        </section>

        <section id="bus-wise-audit" class="page bg-white p-8 rounded-3xl shadow-sm border">
            <h2 class="text-3xl font-black mb-10 text-center">Annual Performance Summary (<span class="year-val"></span>)</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div class="p-6 border rounded-2xl">
                    <h4 class="font-bold mb-4 text-center">Net Profit by Bus</h4>
                    <canvas id="chart-profit"></canvas>
                </div>
                <div class="p-6 border rounded-2xl">
                    <h4 class="font-bold mb-4 text-center">Revenue Distribution</h4>
                    <canvas id="chart-revenue"></canvas>
                </div>
            </div>
        </section>
    </div>

    <script>
        // FIREBASE INITIALIZATION
        const firebaseConfig = {
            apiKey: "AIzaSyBQrSN31bs0dqpyZVT_IeGktPEy7rMrqcQ",
            authDomain: "yaswanth-fleet.firebaseapp.com",
            databaseURL: "https://yaswanth-fleet-default-rtdb.firebaseio.com",
            projectId: "yaswanth-fleet",
            appId: "1:44710091269:web:6bffc1ab51aa52723e9a6c"
        };
        firebase.initializeApp(firebaseConfig);
        const rtdb = firebase.database();

        let selYear = "2026";
        let selMonth = "";
        let selType = "";
        const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];

        // NAVIGATION
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'bus-wise-audit') renderCharts();
            document.querySelectorAll('.year-val').forEach(el => el.textContent = selYear);
        }

        function changeYear(val) {
            selYear = val;
            document.getElementById('display-year').textContent = val;
        }

        function openSelector(type) {
            selType = type;
            document.getElementById('selector-title').innerText = type + " Audit selection";
            const grid = document.getElementById('month-grid');
            grid.innerHTML = months.map(m => `
                <button onclick="handleMonthClick('${m}')" class="p-6 bg-slate-50 rounded-2xl border hover:border-indigo-600 font-bold text-lg transition-all">
                    ${m}
                </button>
            `).join('');
            showPage('selector-page');
        }

        function handleMonthClick(m) {
            selMonth = m;
            if(selType === 'audit') loadAuditData(m);
            // Add similar handlers for diesel and payroll here
        }

        // AUDIT DATA LOGIC
        async function loadAuditData(m) {
            document.getElementById('active-month-name').innerText = m;
            // TARGETING STRUCTURE: auditData/YEAR/MONTH
            const snapshot = await rtdb.ref(`auditData/${selYear}/${m}`).once('value');
            const data = snapshot.val() || [];
            renderAuditTable(Array.isArray(data) ? data : Object.values(data));
            showPage('audit-table-page');
        }

        function renderAuditTable(data) {
            const tbody = document.getElementById('audit-tbody');
            tbody.innerHTML = (data.length ? data : [{busNumber:'', revenue:0, expense:0}]).map((row, i) => `
                <tr class="border-b">
                    <td class="py-4 font-bold" contenteditable="true">${row.busNumber || ''}</td>
                    <td class="py-4 text-green-600 font-semibold" contenteditable="true" onblur="calcTotals()">${(row.revenue || 0).toLocaleString()}</td>
                    <td class="py-4 text-red-600 font-semibold" contenteditable="true" onblur="calcTotals()">${(row.expense || 0).toLocaleString()}</td>
                    <td class="py-4 font-black net-cell">0</td>
                    <td class="py-4 text-right"><button onclick="this.parentElement.parentElement.remove(); calcTotals()" class="text-slate-300 hover:text-red-500">‚úï</button></td>
                </tr>
            `).join('');
            calcTotals();
        }

        function addAuditRow() {
            const tbody = document.getElementById('audit-tbody');
            const tr = document.createElement('tr');
            tr.className = "border-b";
            tr.innerHTML = `<td class="py-4 font-bold" contenteditable="true"></td><td class="py-4 text-green-600 font-semibold" contenteditable="true" onblur="calcTotals()">0</td><td class="py-4 text-red-600 font-semibold" contenteditable="true" onblur="calcTotals()">0</td><td class="py-4 font-black net-cell">0</td><td class="py-4 text-right"><button onclick="this.parentElement.parentElement.remove(); calcTotals()" class="text-slate-300 hover:text-red-500">‚úï</button></td>`;
            tbody.appendChild(tr);
        }

        function calcTotals() {
            let tRev = 0, tExp = 0;
            document.querySelectorAll('#audit-tbody tr').forEach(tr => {
                const r = parseFloat(tr.cells[1].innerText.replace(/,/g,'')) || 0;
                const e = parseFloat(tr.cells[2].innerText.replace(/,/g,'')) || 0;
                tRev += r; tExp += e;
                tr.cells[3].innerText = "‚Çπ" + (r - e).toLocaleString();
                tr.cells[3].style.color = (r - e) >= 0 ? "#4f46e5" : "#ef4444";
            });
            document.getElementById('audit-tfoot').innerHTML = `
                <tr>
                    <td class="py-4">TOTAL FLEET</td>
                    <td class="py-4 text-green-600">‚Çπ${tRev.toLocaleString()}</td>
                    <td class="py-4 text-red-600">‚Çπ${tExp.toLocaleString()}</td>
                    <td class="py-4 text-indigo-600">‚Çπ${(tRev - tExp).toLocaleString()}</td>
                    <td></td>
                </tr>
            `;
        }

        async function saveAuditData() {
            const data = [];
            document.querySelectorAll('#audit-tbody tr').forEach(tr => {
                const bus = tr.cells[0].innerText.trim();
                if(bus) {
                    data.push({
                        busNumber: bus,
                        revenue: parseFloat(tr.cells[1].innerText.replace(/,/g,'')) || 0,
                        expense: parseFloat(tr.cells[2].innerText.replace(/,/g,'')) || 0
                    });
                }
            });
            await rtdb.ref(`auditData/${selYear}/${selMonth}`).set(data);
            alert(`Data for ${selMonth} ${selYear} saved successfully!`);
        }

        // CHARTS LOGIC
        let chartInstances = {};
        async function renderCharts() {
            const snap = await rtdb.ref(`auditData/${selYear}`).once('value');
            const yearData = snap.val() || {};
            const busStats = {};

            Object.values(yearData).forEach(m => {
                const rows = Array.isArray(m) ? m : Object.values(m);
                rows.forEach(r => {
                    if(!busStats[r.busNumber]) busStats[r.busNumber] = { r:0, e:0 };
                    busStats[r.busNumber].r += r.revenue;
                    busStats[r.busNumber].e += r.expense;
                });
            });

            const labels = Object.keys(busStats);
            const profitData = labels.map(l => busStats[l].r - busStats[l].e);
            const revenueData = labels.map(l => busStats[l].r);

            if(chartInstances.p) chartInstances.p.destroy();
            chartInstances.p = new Chart(document.getElementById('chart-profit'), {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Annual Net Profit', data: profitData, backgroundColor: '#6366f1', borderRadius: 8 }] },
                options: { responsive: true }
            });

            if(chartInstances.r) chartInstances.r.destroy();
            chartInstances.r = new Chart(document.getElementById('chart-revenue'), {
                type: 'doughnut',
                data: { labels, datasets: [{ data: revenueData, backgroundColor: ['#4f46e5', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'] }] },
                options: { responsive: true }
            });
        }

        // Startup
        window.onload = () => showPage('home');
    </script>
</body>
</html>
