<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YASWANTH Fleet Audit</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
body{font-family:'Inter',sans-serif}
.page{display:none}
</style>
</head>
<body class="bg-slate-100">

<header class="bg-white p-4 shadow flex justify-between items-center">
<div class="flex gap-3 items-center">
<select id="yearSelector" class="border px-2 py-1 rounded" onchange="changeYear(this.value)"></select>
<button onclick="adminLogin()" class="bg-black text-white px-3 py-1 rounded">Admin</button>
</div>
<nav class="flex gap-4">
<button onclick="showPage('home')">Home</button>
<button onclick="showPage('audit')">Audit</button>
</nav>
</header>

<main class="p-6">
<section id="home" class="page">
<h1 class="text-2xl font-bold">Dashboard</h1>
</section>

<section id="audit" class="page">
<h2 class="text-xl font-bold mb-2">Audit</h2>
<button onclick="openAudit('January')" class="border px-3 py-1">January</button>
<table class="mt-4 w-full border">
<thead><tr><th>Bus</th><th>Revenue</th><th>Expense</th></tr></thead>
<tbody id="auditBody"></tbody>
</table>
<button onclick="saveAudit()" class="bg-green-600 text-white px-3 py-1 mt-2">Save</button>
</section>
</main>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBQrSN31bs0dqpyZVT_IeGktPEy7rMrqcQ",
  databaseURL: "https://yaswanth-fleet-default-rtdb.firebaseio.com"
});
const db = firebase.database();

const YEARS = [2025,2026,2027];
let CURRENT_YEAR = 2026;
let CURRENT_MONTH = "";
let IS_ADMIN = false;

window.onload = () => {
  initYearSelector();
  showPage('home');
};

function initYearSelector(){
  const sel = document.getElementById('yearSelector');
  sel.innerHTML = "";
  YEARS.forEach(y=>{
    const o=document.createElement('option');
    o.value=y;o.text=y;
    if(y===CURRENT_YEAR) o.selected=true;
    sel.appendChild(o);
  });
}

function changeYear(y){
  CURRENT_YEAR = Number(y);
  showPage('home');
}

function adminLogin(){
  const pin = prompt("Enter Admin PIN");
  if(pin==="1234"){
    IS_ADMIN=true;
    alert("Admin enabled");
  } else alert("Wrong PIN");
}

function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.getElementById(id).style.display='block';
}

function openAudit(month){
  CURRENT_MONTH = month;
  loadAudit();
  showPage('audit');
}

function loadAudit(){
  db.ref(`auditData/${CURRENT_YEAR}/${CURRENT_MONTH}`).once('value').then(s=>{
    const data=s.val()||[];
    const arr=Array.isArray(data)?data:Object.values(data);
    const body=document.getElementById('auditBody');
    body.innerHTML="";
    (arr.length?arr:[{}]).forEach(r=>{
      body.innerHTML+=`<tr>
      <td contenteditable="${IS_ADMIN}">${r.bus||""}</td>
      <td contenteditable="${IS_ADMIN}">${r.revenue||""}</td>
      <td contenteditable="${IS_ADMIN}">${r.expense||""}</td>
      </tr>`;
    });
  });
}

function saveAudit(){
  if(!IS_ADMIN) return alert("Admin only");
  const data=[];
  document.querySelectorAll('#auditBody tr').forEach(tr=>{
    data.push({
      bus: tr.cells[0].innerText,
      revenue: Number(tr.cells[1].innerText)||0,
      expense: Number(tr.cells[2].innerText)||0
    });
  });
  db.ref(`auditData/${CURRENT_YEAR}/${CURRENT_MONTH}`).set(data);
  alert("Saved");
}
</script>

</body>
</html>
