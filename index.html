<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YASWANTH Fleet Audit - Rectified</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        [contenteditable="true"] { padding: 4px; border-radius: 4px; transition: all 0.2s; }
        [contenteditable="true"]:focus { background: #fff; outline: 2px solid #6366f1; box-shadow: 0 0 10px rgba(99, 102, 241, 0.2); }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-white border-b sticky top-0 z-50">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <span class="text-2xl font-black text-indigo-600 tracking-tighter">YASWANTH</span>
                <select id="year-select" onchange="updateYear(this.value)" class="bg-slate-100 border-none rounded-lg font-bold text-indigo-700 px-3 py-1">
                    <option value="2025">2025</option>
                    <option value="2026" selected>2026</option>
                </select>
            </div>
            <nav class="flex gap-6 font-bold text-slate-500">
                <button onclick="showPage('home')" class="hover:text-indigo-600">Home</button>
                <button onclick="showPage('reports-page')" class="hover:text-indigo-600">Reports</button>
            </nav>
        </div>
    </header>

    <div class="container mx-auto p-4 md:p-8">
        
        <main id="home" class="page block">
            <h2 class="text-3xl font-black mb-8">Fleet Dashboard - <span class="yr-txt">2026</span></h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div onclick="openMonthGrid('audit')" class="bg-white p-8 rounded-3xl shadow-sm border hover:border-indigo-500 cursor-pointer transition-all">
                    <div class="text-3xl mb-4">üìä</div>
                    <h3 class="text-xl font-bold">Monthly Audit</h3>
                    <p class="text-slate-400 text-sm">Revenue vs Expenses</p>
                </div>
                <div onclick="openMonthGrid('diesel')" class="bg-white p-8 rounded-3xl shadow-sm border hover:border-purple-500 cursor-pointer transition-all">
                    <div class="text-3xl mb-4">‚õΩ</div>
                    <h3 class="text-xl font-bold">Diesel Audit</h3>
                    <p class="text-slate-400 text-sm">Daily Fuel Consumption</p>
                </div>
                <div onclick="openMonthGrid('payroll')" class="bg-white p-8 rounded-3xl shadow-sm border hover:border-amber-500 cursor-pointer transition-all">
                    <div class="text-3xl mb-4">üí∞</div>
                    <h3 class="text-xl font-bold">Payroll</h3>
                    <p class="text-slate-400 text-sm">Driver Settlements</p>
                </div>
            </div>
        </main>

        <section id="grid-page" class="page">
            <button onclick="showPage('home')" class="mb-6 font-bold text-indigo-600">‚Üê Back</button>
            <h2 id="grid-title" class="text-3xl font-black mb-8 capitalize">Select Month</h2>
            <div id="months-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </section>

        <section id="audit-page" class="page bg-white p-6 rounded-3xl border shadow-sm">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-black"><span id="audit-month-label"></span> <span class="yr-txt"></span> Audit</h2>
                <div class="flex gap-2">
                    <button onclick="addAuditRow()" class="bg-slate-100 px-4 py-2 rounded-xl font-bold">+ Bus</button>
                    <button onclick="saveAudit()" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold">Save Data</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="text-slate-400 text-xs uppercase tracking-widest border-b">
                        <tr><th class="pb-4">Bus No</th><th class="pb-4">Revenue</th><th class="pb-4">Expense</th><th class="pb-4">Net</th><th class="pb-4 w-10"></th></tr>
                    </thead>
                    <tbody id="audit-tbody"></tbody>
                </table>
            </div>
        </section>

        <section id="diesel-page" class="page bg-white p-6 rounded-3xl border shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black">Diesel Log: <span id="diesel-month-label"></span></h2>
                <button onclick="saveDiesel()" class="bg-purple-600 text-white px-6 py-2 rounded-xl font-bold">Save Log</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-xs border-collapse" id="diesel-table"></table>
            </div>
        </section>

        <section id="reports-page" class="page">
            <h2 class="text-3xl font-black mb-8 text-center">Fleet Analysis <span class="yr-txt"></span></h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-3xl border shadow-sm"><canvas id="p-chart"></canvas></div>
                <div class="bg-white p-6 rounded-3xl border shadow-sm"><canvas id="r-chart"></canvas></div>
            </div>
        </section>

    </div>

    <script>
        // FIREBASE SETUP
        const firebaseConfig = {
            apiKey: "AIzaSyBQrSN31bs0dqpyZVT_IeGktPEy7rMrqcQ",
            authDomain: "yaswanth-fleet.firebaseapp.com",
            databaseURL: "https://yaswanth-fleet-default-rtdb.firebaseio.com",
            projectId: "yaswanth-fleet",
            appId: "1:44710091269:web:6bffc1ab51aa52723e9a6c"
        };
        firebase.initializeApp(firebaseConfig);
        const rtdb = firebase.database();

        let currentYear = "2026";
        let currentMonth = "";
        let currentMode = ""; // audit, diesel, payroll
        const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        const dieselBuses = ['9721', '9722', '9932', '9935', '9937', '9938', '4680', '4681', '4319', '4320'];

        // NAVIGATION LOGIC
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'reports-page') initReports();
        }

        function updateYear(val) {
            currentYear = val;
            document.querySelectorAll('.yr-txt').forEach(el => el.textContent = val);
        }

        function openMonthGrid(mode) {
            currentMode = mode;
            document.getElementById('grid-title').innerText = mode + " Selection";
            const container = document.getElementById('months-container');
            container.innerHTML = months.map(m => `
                <button onclick="handleMonthSelection('${m}')" class="bg-white p-6 rounded-2xl border font-bold hover:border-indigo-600 transition">
                    ${m}
                </button>
            `).join('');
            showPage('grid-page');
        }

        function handleMonthSelection(m) {
            currentMonth = m;
            if(currentMode === 'audit') loadAudit(m);
            if(currentMode === 'diesel') loadDiesel(m);
            // if(currentMode === 'payroll') loadPayroll(m);
        }

        // MONTHLY AUDIT LOGIC
        async function loadAudit(m) {
            document.getElementById('audit-month-label').innerText = m;
            const snap = await rtdb.ref(`auditData/${currentYear}/${m}`).once('value');
            const data = snap.val() || [];
            const rows = Array.isArray(data) ? data : Object.values(data);
            
            const tbody = document.getElementById('audit-tbody');
            tbody.innerHTML = (rows.length ? rows : [{busNumber:'', revenue:0, expense:0}]).map(row => `
                <tr class="border-b">
                    <td class="py-4 font-bold" contenteditable="true">${row.busNumber || ''}</td>
                    <td class="py-4 text-green-600 font-bold" contenteditable="true" onblur="calcAudit()">${(row.revenue || 0).toLocaleString()}</td>
                    <td class="py-4 text-red-600 font-bold" contenteditable="true" onblur="calcAudit()">${(row.expense || 0).toLocaleString()}</td>
                    <td class="py-4 font-black net-val">0</td>
                    <td class="py-4"><button onclick="this.parentElement.parentElement.remove(); calcAudit()" class="text-slate-300 hover:text-red-500">‚úï</button></td>
                </tr>
            `).join('');
            calcAudit();
            showPage('audit-page');
        }

        function calcAudit() {
            document.querySelectorAll('#audit-tbody tr').forEach(tr => {
                const r = parseFloat(tr.cells[1].innerText.replace(/,/g,'')) || 0;
                const e = parseFloat(tr.cells[2].innerText.replace(/,/g,'')) || 0;
                const n = r - e;
                tr.cells[3].innerText = "‚Çπ" + n.toLocaleString();
                tr.cells[3].style.color = n >= 0 ? "#4f46e5" : "#ef4444";
            });
        }

        async function saveAudit() {
            const data = [];
            document.querySelectorAll('#audit-tbody tr').forEach(tr => {
                const bus = tr.cells[0].innerText.trim();
                if(bus) data.push({
                    busNumber: bus,
                    revenue: parseFloat(tr.cells[1].innerText.replace(/,/g,'')) || 0,
                    expense: parseFloat(tr.cells[2].innerText.replace(/,/g,'')) || 0
                });
            });
            await rtdb.ref(`auditData/${currentYear}/${currentMonth}`).set(data);
            alert("Audit saved to " + currentYear);
        }

        function addAuditRow() {
            const tr = document.createElement('tr');
            tr.className = "border-b";
            tr.innerHTML = `<td class="py-4 font-bold" contenteditable="true"></td><td class="py-4 text-green-600 font-bold" contenteditable="true" onblur="calcAudit()">0</td><td class="py-4 text-red-600 font-bold" contenteditable="true" onblur="calcAudit()">0</td><td class="py-4 font-black net-val">0</td><td class="py-4"><button onclick="this.parentElement.parentElement.remove(); calcAudit()">‚úï</button></td>`;
            document.getElementById('audit-tbody').appendChild(tr);
        }

        // DIESEL LOGIC
        async function loadDiesel(m) {
            document.getElementById('diesel-month-label').innerText = m + " " + currentYear;
            const snap = await rtdb.ref(`dieselData/${currentYear}/${m}`).once('value');
            const savedData = snap.val() || {};

            const days = new Date(currentYear, months.indexOf(m) + 1, 0).getDate();
            const table = document.getElementById('diesel-table');
            
            let html = `<thead><tr class="bg-slate-50"><th class="p-2 border sticky left-0 bg-slate-50">Bus</th>`;
            for(let d=1; d<=days; d++) html += `<th class="p-1 border text-center">${d}</th>`;
            html += `<th class="p-2 border">Total</th></tr></thead><tbody>`;

            dieselBuses.forEach(bus => {
                html += `<tr><td class="p-2 border font-bold sticky left-0 bg-white">${bus}</td>`;
                let rowSum = 0;
                for(let d=1; d<=days; d++) {
                    const val = savedData[bus] ? (savedData[bus][d] || '') : '';
                    html += `<td contenteditable="true" class="p-1 border text-center d-input" data-bus="${bus}" data-day="${d}" onblur="sumDiesel()">${val}</td>`;
                }
                html += `<td class="p-2 border font-black bus-sum">0</td></tr>`;
            });
            table.innerHTML = html + `</tbody>`;
            sumDiesel();
            showPage('diesel-page');
        }

        function sumDiesel() {
            document.querySelectorAll('#diesel-table tbody tr').forEach(tr => {
                let sum = 0;
                tr.querySelectorAll('.d-input').forEach(td => sum += parseFloat(td.innerText) || 0);
                tr.querySelector('.bus-sum').innerText = sum.toLocaleString();
            });
        }

        async function saveDiesel() {
            const data = {};
            document.querySelectorAll('.d-input').forEach(td => {
                const b = td.dataset.bus, d = td.dataset.day, v = parseFloat(td.innerText) || 0;
                if(v > 0) {
                    if(!data[b]) data[b] = {};
                    data[b][d] = v;
                }
            });
            await rtdb.ref(`dieselData/${currentYear}/${currentMonth}`).set(data);
            alert("Diesel log saved!");
        }

        // REPORTS
        let chartInstances = {};
        async function initReports() {
            const snap = await rtdb.ref(`auditData/${currentYear}`).once('value');
            const yearData = snap.val() || {};
            const busAgg = {};

            Object.values(yearData).forEach(m => {
                const entries = Array.isArray(m) ? m : Object.values(m);
                entries.forEach(e => {
                    if(!busAgg[e.busNumber]) busAgg[e.busNumber] = { r:0, e:0 };
                    busAgg[e.busNumber].r += e.revenue;
                    busAgg[e.busNumber].e += e.expense;
                });
            });

            const labels = Object.keys(busAgg);
            const profits = labels.map(l => busAgg[l].r - busAgg[l].e);

            if(chartInstances.p) chartInstances.p.destroy();
            chartInstances.p = new Chart(document.getElementById('p-chart'), {
                type: 'bar', data: { labels, datasets: [{ label: 'Annual Net Profit', data: profits, backgroundColor: '#6366f1' }] }
            });
        }

        updateYear("2026");
    </script>
</body>
</html>
